<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plexura Universal Safety Advisor</title>
    
    <!-- CDN Link for Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script> 

    <!-- CDN Link for Clipboard.js -->
    <script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script>

    <!-- Font (Will load from Google Fonts) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        
        /* Custom Form Styles */
        input[type="radio"]:checked + label,
        input[type="checkbox"]:checked + label { 
            border-color: #2563eb; 
            background-color: #eff6ff; 
        }
        
        /* Risk Warning Styles */
        input[type="radio"][data-risk="true"]:checked + label { 
            border-color: #f59e0b; 
            background-color: #fffbeb; 
        }
        
        /* Danger Warning Styles */
        input[type="radio"][data-danger="true"]:checked + label { 
            border-color: #ef4444; 
            background-color: #fef2f2; 
        }
        
        input[type="radio"], input[type="checkbox"] { display: none; }
        
        /* Result Card Themes */
        .result-safe { background-color: #f0fdf4; border-color: #22c55e; }
        .result-caution { background-color: #fffbeb; border-color: #f59e0b; }
        .result-danger { background-color: #fef2f2; border-color: #ef4444; }
        
        /* Modal Transitions */
        .modal { transition: opacity 0.2s ease; }
        .modal-content { transition: transform 0.2s ease; }
        
        /* Header Interaction */
        #policy-button { transition: background-color 0.15s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8 text-gray-800">

    <!-- Settings Modal (Local Policy) -->
    <div id="settings-modal" class="modal fixed inset-0 z-50 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div id="settings-modal-content" class="modal-content w-full max-w-lg bg-white rounded-2xl shadow-xl p-6 transform scale-95">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900">Local Policy Settings</h3>
                <button id="close-settings" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-6">Set the eGFR thresholds that trigger "Moderate Risk" warnings in your department.</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">CT (IV) Caution Threshold</label>
                    <input type="number" id="ct-iv-threshold" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="30">
                    <p class="text-xs text-gray-500 mt-1">Default (ACR): 30</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">CT (IA - Other) Caution Threshold</label>
                    <input type="number" id="ct-ia-other-threshold" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="40">
                    <p class="text-xs text-gray-500 mt-1">Default (ACR): 40</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">CT (IA - Renal) Caution Threshold</label>
                    <input type="number" id="ct-ia-renal-threshold" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="60">
                    <p class="text-xs text-gray-500 mt-1">Default (ACR): 60</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">MRI (GBCM) Caution Threshold</label>
                    <input type="number" id="mri-threshold" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="30">
                    <p class="text-xs text-gray-500 mt-1">Default (ACR): 30</p>
                </div>
            </div>
            <div class="mt-6 flex justify-between items-center">
                <button id="reset-settings" class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-all">Reset to Default</button>
                <button id="save-settings" class="px-5 py-2 bg-blue-600 text-white rounded-lg shadow-sm font-medium hover:bg-blue-700 transition-all">Save and Close</button>
            </div>
        </div>
    </div>

    <!-- Nephrotoxic Drug Helper Modal -->
    <div id="nephrotoxic-modal" class="modal fixed inset-0 z-50 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div id="nephrotoxic-modal-content" class="modal-content w-full max-w-lg bg-white rounded-2xl shadow-xl p-6 transform scale-95">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900">Nephrotoxic Drug Check</h3>
                <button id="close-nephrotoxic" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-6">Ask the patient about these common classes. If they take <strong>any</strong>, check the box.</p>
            <ul class="space-y-4 text-sm">
                <li>
                    <strong class="font-semibold text-gray-800">1. NSAIDs (Pain/Arthritis):</strong>
                    <p class="text-gray-600">"Are you taking Ibuprofen (Advil), Naproxen (Aleve), or Diclofenac (Voltaren)?"</p>
                </li>
                <li>
                    <strong class="font-semibold text-gray-800">2. Strong IV Antibiotics (Inpatients):</strong>
                    <p class="text-gray-600">Gentamicin, Amikacin, Tobramycin, Vancomycin?</p>
                </li>
                <li>
                    <strong class="font-semibold text-gray-800">3. Diuretics (Water Pills):</strong>
                    <p class="text-gray-600">"Furosemide (Lasix)?" (Risk via dehydration/volume depletion).</p>
                </li>
            </ul>
            <button id="close-nephrotoxic-2" class="mt-6 w-full px-5 py-2 bg-blue-600 text-white rounded-lg shadow-sm font-medium hover:bg-blue-700 transition-all">Close</button>
        </div>
    </div>

    <!-- Main Tool Container -->
    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        
        <!-- Header -->
        <div class="p-6 md:p-8 border-b border-gray-200 flex flex-col items-center text-center">
            <!-- Logo with Fallback -->
            <img src="contrast.png" alt="Plexura Logo" class="w-40 h-40 rounded-full mb-6 shadow-lg object-cover" 
                 onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='flex';">
            <div id="logo-fallback" class="w-40 h-40 rounded-full mb-6 shadow-lg bg-gray-800 flex items-center justify-center hidden">
                <span class="text-4xl font-bold text-white">Plexura</span>
            </div>
            
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
                <span class="text-blue-600">Plexura</span> Universal Safety Advisor
            </h1>
            
            <!-- Interactive Policy Display (No Floating Icon) -->
            <button id="policy-button" class="mt-2 text-sm md:text-base text-gray-500 hover:text-blue-600 hover:bg-blue-50 px-3 py-1 rounded-full transition-colors cursor-pointer">
                Using Default ACR v2024 Guidelines <span class="font-semibold text-xs align-top ml-1">EDIT</span>
            </button>
        </div>

        <div class="md:grid md:grid-cols-5">
            
            <!-- LEFT COLUMN: INPUTS -->
            <form id="advisor-form" class="md:col-span-2 p-6 md:p-8 space-y-8 border-r border-gray-200">
                
                <!-- Section 1: Patient Data -->
                <fieldset class="space-y-4">
                    <legend class="text-lg font-bold text-gray-900 border-b pb-1 w-full">1. Patient Data</legend>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Creatinine</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <input type="number" id="creatinine" min="0.1" max="30" step="0.01" class="flex-1 block w-full rounded-l-md border-gray-300 border p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="1.2" required>
                                <span class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">mg/dL</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Age</label>
                            <input type="number" id="age" min="1" max="120" step="1" class="mt-1 block w-full rounded-md border-gray-300 border p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="65" required>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sex</label>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="radio" name="sex" value="male" id="sex-male" checked>
                            <label for="sex-male" class="text-center py-2 border rounded-md cursor-pointer font-medium text-gray-700 hover:bg-gray-50">Male</label>
                            
                            <input type="radio" name="sex" value="female" id="sex-female">
                            <label for="sex-female" class="text-center py-2 border rounded-md cursor-pointer font-medium text-gray-700 hover:bg-gray-50">Female</label>
                        </div>
                    </div>
                </fieldset>

                <!-- Section 2: Procedure -->
                <fieldset class="space-y-4">
                    <legend class="text-lg font-bold text-gray-900 border-b pb-1 w-full">2. Procedure</legend>
                    
                    <!-- CT Option -->
                    <input type="radio" name="procedure" value="ct" id="proc-ct" checked>
                    <label for="proc-ct" class="flex items-center justify-between p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <span class="font-bold text-gray-800">CT (Iodinated Contrast)</span>
                    </label>
                    
                    <!-- CT Sub-options -->
                    <div id="ct-options" class="ml-4 pl-4 border-l-2 border-blue-100 space-y-2">
                        <input type="radio" name="ct_route" value="iv" id="ct-iv" checked>
                        <label for="ct-iv" class="block p-3 border rounded-md cursor-pointer hover:bg-gray-50">
                            <span class="block font-medium text-gray-900">Intravenous (IV)</span>
                            <span class="block text-xs text-gray-500">Standard CT, CTU</span>
                        </label>

                        <input type="radio" name="ct_route" value="ia_other" id="ct-ia-other">
                        <label for="ct-ia-other" class="block p-3 border rounded-md cursor-pointer hover:bg-gray-50">
                            <span class="block font-medium text-gray-900">IA - Other (High Volume)</span>
                            <span class="block text-xs text-gray-500">PCI, Cerebral, Peripheral</span>
                        </label>

                        <input type="radio" name="ct_route" value="ia_renal" id="ct-ia-renal">
                        <label for="ct-ia-renal" class="block p-3 border rounded-md cursor-pointer hover:bg-gray-50">
                            <span class="block font-medium text-gray-900">IA - Renal First-Pass</span>
                            <span class="block text-xs text-gray-500">Renal Angio (Highest Risk)</span>
                        </label>
                    </div>

                    <!-- MRI Option -->
                    <input type="radio" name="procedure" value="mri" id="proc-mri">
                    <label for="proc-mri" class="flex items-center justify-between p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <span class="font-bold text-gray-800">MRI (Gadolinium)</span>
                    </label>

                    <!-- MRI Sub-options -->
                    <div id="mri-options" class="ml-4 pl-4 border-l-2 border-blue-100 space-y-2 hidden">
                        <input type="radio" name="gbcm" value="group2" id="gbcm-g2" checked>
                        <label for="gbcm-g2" class="block p-3 border rounded-md cursor-pointer hover:bg-gray-50">
                            <span class="block font-medium text-gray-900">Group II (Macrocyclic)</span>
                            <span class="block text-xs text-gray-500">Gadavist, Dotarem (Low Risk)</span>
                        </label>

                        <input type="radio" name="gbcm" value="group1" id="gbcm-g1" data-danger="true">
                        <label for="gbcm-g1" class="block p-3 border rounded-md cursor-pointer hover:bg-gray-50">
                            <span class="block font-medium text-gray-900">Group I (Linear)</span>
                            <span class="block text-xs text-gray-500">Magnevist (High NSF Risk)</span>
                        </label>
                        
                        <input type="radio" name="gbcm" value="group3" id="gbcm-g3" data-danger="true">
                        <label for="gbcm-g3" class="block p-3 border rounded-md cursor-pointer hover:bg-gray-50">
                            <span class="block font-medium text-gray-900">Group III (Linear)</span>
                            <span class="block text-xs text-gray-500">Eovist (Limited Data)</span>
                        </label>
                    </div>
                </fieldset>

                <!-- Section 3: Safety Checklist (The "Elite" Feature) -->
                <fieldset class="space-y-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <legend class="text-lg font-bold text-gray-900 border-b pb-1 w-full">3. Clinical Safety Checklist</legend>
                    <p class="text-xs text-gray-500 mb-2">Defaults are set for a standard, low-risk patient. Verify all.</p>

                    <!-- Reaction -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Prior Contrast Reaction?</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="radio" name="reaction" value="no" id="reaction-no" checked>
                            <label for="reaction-no" class="text-center py-2 border rounded-md cursor-pointer text-sm font-medium text-gray-700 bg-white">No / Unknown</label>
                            
                            <input type="radio" name="reaction" value="yes" id="reaction-yes" data-danger="true">
                            <label for="reaction-yes" class="text-center py-2 border rounded-md cursor-pointer text-sm font-medium text-gray-700 bg-white">Yes (Mod/Severe)</label>
                        </div>
                    </div>

                    <!-- Fasting -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ASA Fasting Compliant? <span class="font-normal text-gray-500">(6h solids / 2h clears)</span></label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="radio" name="fasting" value="yes" id="fasting-yes" checked>
                            <label for="fasting-yes" class="text-center py-2 border rounded-md cursor-pointer text-sm font-medium text-gray-700 bg-white">Yes</label>
                            
                            <input type="radio" name="fasting" value="no" id="fasting-no" data-risk="true">
                            <label for="fasting-no" class="text-center py-2 border rounded-md cursor-pointer text-sm font-medium text-gray-700 bg-white">No</label>
                        </div>
                    </div>

                    <!-- Comorbidities -->
                    <div class="space-y-2">
                        <input type="checkbox" id="is-metformin" name="is-metformin">
                        <label for="is-metformin" class="flex justify-between items-center p-3 border rounded-md bg-white cursor-pointer hover:bg-gray-50">
                            <span class="font-medium text-gray-800 text-sm">Taking Metformin</span>
                        </label>

                        <div>
                            <input type="checkbox" id="is-nephrotoxic" name="is-nephrotoxic">
                            <label for="is-nephrotoxic" class="flex justify-between items-center p-3 border rounded-md bg-white cursor-pointer hover:bg-gray-50">
                                <span class="font-medium text-gray-800 text-sm">High-Risk Nephrotoxins</span>
                            </label>
                            <button id="nephrotoxic-help" class="text-xs text-blue-600 font-medium mt-1 ml-1 hover:underline">What does this include?</button>
                        </div>

                        <input type="checkbox" id="is-single-kidney" name="is-single-kidney">
                        <label for="is-single-kidney" class="flex justify-between items-center p-3 border rounded-md bg-white cursor-pointer hover:bg-gray-50">
                            <span class="font-medium text-gray-800 text-sm">Single Kidney</span>
                        </label>

                        <!-- Pregnancy (Contingent) -->
                        <div id="pregnancy-container" class="hidden">
                            <input type="checkbox" id="is-pregnant" name="is-pregnant">
                            <label for="is-pregnant" class="flex justify-between items-center p-3 border rounded-md bg-white cursor-pointer hover:bg-gray-50 border-red-200">
                                <span class="font-bold text-red-700 text-sm">Patient is Pregnant</span>
                            </label>
                        </div>
                    </div>
                </fieldset>

                <!-- Section 4: Renal Status -->
                <fieldset class="space-y-3">
                    <legend class="text-lg font-bold text-gray-900 border-b pb-1 w-full">4. Renal Status</legend>
                    
                    <input type="radio" name="status" value="standard" id="status-standard" checked>
                    <label for="status-standard" class="block p-3 border rounded-md cursor-pointer hover:bg-gray-50">
                        <span class="block font-medium text-gray-900">Standard Patient</span>
                        <span class="block text-xs text-gray-500">Stable or unknown baseline</span>
                    </label>

                    <input type="radio" name="status" value="aki" id="status-aki" data-danger="true">
                    <label for="status-aki" class="block p-3 border rounded-md cursor-pointer hover:bg-gray-50">
                        <span class="block font-bold text-gray-900">Acute Kidney Injury (AKI)</span>
                        <span class="block text-xs text-gray-500">Current, unstable renal failure</span>
                    </label>

                    <input type="radio" name="status" value="dialysis" id="status-dialysis" data-risk="true">
                    <label for="status-dialysis" class="block p-3 border rounded-md cursor-pointer hover:bg-gray-50">
                        <span class="block font-bold text-gray-900">On Dialysis (ESRD)</span>
                    </label>

                    <!-- Dialysis Detail (MRI Only) -->
                    <div id="dialysis-options" class="hidden ml-4 pl-4 border-l-2 border-blue-100 space-y-2">
                        <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Dialysis Workflow (MRI)</p>
                        <input type="checkbox" id="dialysis-high-dose" name="dialysis-high-dose">
                        <label for="dialysis-high-dose" class="block p-2 border rounded-md bg-white cursor-pointer text-sm">High Dose? (e.g. MRA)</label>
                        
                        <input type="checkbox" id="dialysis-delayed" name="dialysis-delayed">
                        <label for="dialysis-delayed" class="block p-2 border rounded-md bg-white cursor-pointer text-sm">Next Dialysis > 24h?</label>
                    </div>
                </fieldset>

            </form>

            <!-- RIGHT COLUMN: RESULTS -->
            <div class="md:col-span-3 bg-gray-50 p-6 md:p-8 flex flex-col">
                <div class="sticky top-8 space-y-6">
                    
                    <!-- eGFR Box -->
                    <div class="bg-white p-6 rounded-xl border shadow-sm">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Calculated eGFR (2021 CKD-EPI)</p>
                        <div class="flex items-baseline mt-1">
                            <span id="egfr-result" class="text-4xl font-extrabold text-blue-600">--</span>
                            <span class="ml-2 text-sm text-gray-500">mL/min/1.73mÂ²</span>
                        </div>
                    </div>

                    <!-- Recommendation Card -->
                    <div id="result-card" class="bg-white p-6 rounded-xl border-2 result-caution shadow-md">
                        <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Risk Profile</p>
                        <h2 id="risk-profile" class="text-2xl font-bold text-yellow-700 mb-4">AWAITING INPUT</h2>
                        
                        <div class="border-t border-gray-200 pt-4">
                            <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Final Recommendation</p>
                            <p id="recommendation" class="text-lg font-medium text-gray-900">Please enter patient data.</p>
                        </div>

                        <!-- Dynamic Guidance Blocks -->
                        <div class="mt-4 space-y-3">
                            <div id="guidance-main" class="hidden p-3 bg-white rounded border border-gray-200">
                                <span class="font-bold text-gray-800 block text-sm mb-1">Primary Advisory:</span>
                                <span class="text-sm text-gray-700"></span>
                            </div>
                            <div id="guidance-renal" class="hidden p-3 bg-white rounded border border-gray-200">
                                <span class="font-bold text-gray-800 block text-sm mb-1">Renal Advisory:</span>
                                <span class="text-sm text-gray-700"></span>
                            </div>
                            <div id="guidance-metformin" class="hidden p-3 bg-white rounded border border-gray-200">
                                <span class="font-bold text-gray-800 block text-sm mb-1">Metformin Action:</span>
                                <span class="text-sm text-gray-700"></span>
                            </div>
                            <div id="guidance-alternatives" class="hidden p-3 bg-white rounded border border-gray-200">
                                <span class="font-bold text-gray-800 block text-sm mb-1">Alternatives:</span>
                                <span class="text-sm text-gray-700"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Copy Button -->
                    <button id="copy-button" data-clipboard-target="#report-text" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow transition-colors flex items-center justify-center">
                        <span id="copy-icon" class="mr-2">ðŸ“‹</span> Copy Summary for Report
                    </button>
                    
                    <!-- Hidden Report Text -->
                    <div id="report-text" class="absolute opacity-0 pointer-events-none"></div>

                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-gray-50 border-t p-6 text-center text-xs text-gray-500">
            <p>Â© Plexura 2025 Â· The Living Mind of Diagnostic Intelligence</p>
            <p class="mt-1">
                <a href="contrast-reference.pdf" target="_blank" class="text-blue-600 hover:underline font-medium">View Reference Document</a>
                <span class="mx-1">â€¢</span>
                For educational use only.
            </p>
        </footer>
    </div>

    <!-- Application Logic -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- 1. Policy Management ---
        const defaultPolicy = { ct_iv: 30, ct_ia_other: 40, ct_ia_renal: 60, mri: 30 };
        let localPolicy = JSON.parse(localStorage.getItem('plexuraPolicy')) || { ...defaultPolicy };

        // DOM Elements for Settings
        const policyButton = document.getElementById('policy-button');
        const settingsModal = document.getElementById('settings-modal');
        const settingsContent = document.getElementById('settings-modal-content');
        const closeSettings = document.getElementById('close-settings');
        const saveSettings = document.getElementById('save-settings');
        const resetSettings = document.getElementById('reset-settings');
        
        // Modal Logic
        function openModal(m, c) { m.classList.remove('hidden'); setTimeout(() => { m.classList.remove('opacity-0'); c.classList.remove('scale-95'); }, 10); }
        function closeModal(m, c) { m.classList.add('opacity-0'); c.classList.add('scale-95'); setTimeout(() => m.classList.add('hidden'), 200); }

        policyButton.onclick = () => {
            document.getElementById('ct-iv-threshold').value = localPolicy.ct_iv;
            document.getElementById('ct-ia-other-threshold').value = localPolicy.ct_ia_other;
            document.getElementById('ct-ia-renal-threshold').value = localPolicy.ct_ia_renal;
            document.getElementById('mri-threshold').value = localPolicy.mri;
            openModal(settingsModal, settingsContent);
        };
        closeSettings.onclick = () => closeModal(settingsModal, settingsContent);

        saveSettings.onclick = () => {
            localPolicy.ct_iv = parseInt(document.getElementById('ct-iv-threshold').value) || 30;
            localPolicy.ct_ia_other = parseInt(document.getElementById('ct-ia-other-threshold').value) || 40;
            localPolicy.ct_ia_renal = parseInt(document.getElementById('ct-ia-renal-threshold').value) || 60;
            localPolicy.mri = parseInt(document.getElementById('mri-threshold').value) || 30;
            localStorage.setItem('plexuraPolicy', JSON.stringify(localPolicy));
            updateUI();
            closeModal(settingsModal, settingsContent);
        };

        resetSettings.onclick = () => {
            localPolicy = { ...defaultPolicy };
            localStorage.removeItem('plexuraPolicy');
            updateUI();
            closeModal(settingsModal, settingsContent);
        };

        // --- 2. Nephrotoxic Helper ---
        const nephModal = document.getElementById('nephrotoxic-modal');
        const nephContent = document.getElementById('nephrotoxic-modal-content');
        document.getElementById('nephrotoxic-help').onclick = (e) => { e.preventDefault(); openModal(nephModal, nephContent); };
        document.getElementById('close-nephrotoxic').onclick = () => closeModal(nephModal, nephContent);
        document.getElementById('close-nephrotoxic-2').onclick = () => closeModal(nephModal, nephContent);

        // --- 3. Core Logic & Calculation ---
        
        // Elements
        const form = document.getElementById('advisor-form');
        const creatEl = document.getElementById('creatinine');
        const ageEl = document.getElementById('age');
        const sexRadios = document.getElementsByName('sex');
        const pregnantCheck = document.getElementById('is-pregnant');
        
        // Results Elements
        const egfrEl = document.getElementById('egfr-result');
        const card = document.getElementById('result-card');
        const riskTitle = document.getElementById('risk-profile');
        const recText = document.getElementById('recommendation');
        const reportDiv = document.getElementById('report-text');

        // CKD-EPI 2021 Formula
        function calculateEGFR(cr, age, isFemale) {
            if (!cr || !age || cr <= 0 || age <= 0) return null;
            const k = isFemale ? 0.7 : 0.9;
            const a = isFemale ? -0.241 : -0.302;
            const min = Math.min(cr/k, 1);
            const max = Math.max(cr/k, 1);
            let egfr = 142 * Math.pow(min, a) * Math.pow(max, -1.200) * Math.pow(0.9938, age);
            if (isFemale) egfr *= 1.012;
            return Math.round(egfr);
        }

        // Helpers
        const getVal = (name) => document.querySelector(`input[name="${name}"]:checked`).value;
        const show = (id, msg) => { 
            const el = document.getElementById(id); 
            if (el) {
                el.classList.remove('hidden'); 
                const child = el.children[1]; // Assumes target is the second child
                if(child) child.innerHTML = msg; 
            }
        };
        const hideAllGuides = () => ['guidance-main','guidance-renal','guidance-metformin','guidance-alternatives'].forEach(id => {
             const el = document.getElementById(id);
             if(el) el.classList.add('hidden');
        });
        const setStyle = (type) => {
            card.className = `bg-white p-6 rounded-xl border-2 shadow-md ${type === 'safe' ? 'result-safe' : type === 'danger' ? 'result-danger' : 'result-caution'}`;
            riskTitle.className = `text-2xl font-bold mb-4 ${type === 'safe' ? 'text-green-700' : type === 'danger' ? 'text-red-700' : 'text-yellow-700'}`;
        };

        // --- THE MEGA ALGORITHM ---
        function updateUI() {
            // 1. Input & Visibility
            const proc = getVal('procedure');
            const status = getVal('status');
            const isFemale = document.querySelector('input[name="sex"][value="female"]').checked;
            
            // Show/Hide Sections
            document.getElementById('ct-options').classList.toggle('hidden', proc !== 'ct');
            document.getElementById('mri-options').classList.toggle('hidden', proc !== 'mri');
            document.getElementById('dialysis-options').classList.toggle('hidden', !(status === 'dialysis' && proc === 'mri'));
            document.getElementById('pregnancy-container').classList.toggle('hidden', !isFemale);
            
            if (!isFemale && pregnantCheck.checked) pregnantCheck.checked = false;

            // Update Policy Text
            const isDef = JSON.stringify(localPolicy) === JSON.stringify(defaultPolicy);
            policyButton.innerHTML = `Using ${isDef ? 'Default ACR v2024' : 'Local'} Guidelines (CT-IV < ${localPolicy.ct_iv}, MRI < ${localPolicy.mri}) <span class="font-semibold text-xs align-top ml-1 text-blue-600">EDIT</span>`;

            // 2. Get Data
            const cr = parseFloat(creatEl.value);
            const age = parseInt(ageEl.value);
            const egfr = calculateEGFR(cr, age, isFemale);
            
            hideAllGuides();

            if (!cr || !age || egfr === null) {
                egfrEl.innerText = "--";
                riskTitle.innerText = "AWAITING INPUT";
                recText.innerText = "Please enter valid patient data.";
                setStyle('caution');
                updateReport({pat: 'N/A', egfr: 'N/A', risk: 'Awaiting Input', rec: 'Awaiting Input', notes:[]});
                return;
            }
            egfrEl.innerText = egfr;

            // Report Builder
            let r = { pat: `${age}y ${isFemale?'F':'M'}, Cr ${cr}`, egfr: egfr, risk: '', rec: '', notes: [] };

            // --- LOGIC PILLARS ---

            // A. Fatal Risks (Overrides)
            if (pregnantCheck.checked) {
                setStyle('danger');
                riskTitle.innerText = "HIGH RISK (FETAL EXPOSURE)";
                if (proc === 'ct') {
                    recText.innerText = "DEFER SCAN. Radiation risk to fetus.";
                    show('guidance-main', "Iodinated contrast is low risk, but radiation is the primary concern. Defer until post-partum unless life-threatening.");
                    show('guidance-alternatives', "Ultrasound or Non-contrast MRI.");
                } else {
                    recText.innerText = "CONTRAINDICATED. GBCMs cross placenta.";
                    show('guidance-main', "Gadolinium crosses the placenta and is re-circulated by the fetus, leading to prolonged exposure. Avoid unless absolutely essential.");
                    show('guidance-alternatives', "Non-contrast MRI or Ultrasound.");
                }
                r.risk = "HIGH RISK (Pregnancy)"; r.rec = recText.innerText; updateReport(r); return;
            }

            if (getVal('reaction') === 'yes') {
                setStyle('danger');
                riskTitle.innerText = "HIGH RISK (ANAPHYLAXIS)";
                recText.innerText = "STOP. History of moderate/severe reaction.";
                show('guidance-main', "Consult radiologist. A different contrast class (CT vs MRI) might be safe. Premedication protocol is required.");
                r.risk = "HIGH RISK (Prior Reaction)"; r.rec = recText.innerText; updateReport(r); return;
            }

            if (getVal('fasting') === 'no') {
                setStyle('caution');
                riskTitle.innerText = "MODERATE RISK (ASPIRATION)";
                recText.innerText = "DEFER ELECTIVE SCAN. Not ASA Compliant.";
                show('guidance-main', "Patient has not met NPO guidelines (6h solids / 2h clears). Aspiration risk if vomiting occurs. Reschedule elective scan.");
                show('guidance-alternatives', "If scan is emergent, proceed with caution and inform team of aspiration risk.");
                r.risk = "MODERATE (Fasting Non-compliant)"; r.rec = recText.innerText; updateReport(r); return;
            }

            // B. Renal Risks
            const isMetformin = document.getElementById('is-metformin').checked;
            
            if (status === 'dialysis') {
                r.pat += " (Dialysis)";
                if (proc === 'ct') {
                    setStyle('safe');
                    riskTitle.innerText = "LOW RISK (RENAL)";
                    recText.innerText = "PROCEED. Iodinated contrast is safe.";
                    show('guidance-renal', "No urgent dialysis needed. Continue normal schedule.");
                    if(isMetformin) { show('guidance-metformin', "No hold required (Dialysis patient)."); r.notes.push("Metformin: No hold required.") }
                } else {
                    const gbcm = getVal('gbcm');
                    if (gbcm !== 'group2') {
                        setStyle('danger');
                        riskTitle.innerText = "HIGH RISK (NSF)";
                        recText.innerText = "CONTRAINDICATED. Use Group II only.";
                        show('guidance-alternatives', "Switch to Group II (Macrocyclic) GBCM or use non-contrast MRI.");
                    } else {
                        const highDose = document.getElementById('dialysis-high-dose').checked;
                        const delayed = document.getElementById('dialysis-delayed').checked;
                        if (highDose || delayed) {
                            setStyle('caution');
                            riskTitle.innerText = "MODERATE RISK (Theor. NSF)";
                            recText.innerText = "PROCEED W/ CAUTION. Dialysis recommended < 24h.";
                            show('guidance-main', "High dose or long dwell time increases theoretical risk of GBCM dissociation. Obtain consent.");
                            r.notes.push("Recommend dialysis < 24h post-scan.");
                        } else {
                            setStyle('safe');
                            riskTitle.innerText = "LOW RISK (NSF)";
                            recText.innerText = "PROCEED. Group II safe.";
                            show('guidance-main', "Standard dose Group II GBCM is safe. Continue normal dialysis schedule.");
                        }
                    }
                }
                r.risk = riskTitle.innerText; r.rec = recText.innerText; updateReport(r); return;
            }

            if (status === 'aki') {
                r.pat += " (AKI)";
                r.egfr = "N/A (Invalid in AKI)";
                if (proc === 'ct') {
                    setStyle('danger');
                    riskTitle.innerText = "HIGH RISK (PC-AKI)";
                    recText.innerText = "DEFER SCAN. Renal function unstable.";
                    show('guidance-main', "If scan is emergent: Low dose, IV hydration, Hold all nephrotoxins.");
                    show('guidance-alternatives', "Non-contrast CT, Ultrasound, or non-contrast MRI.");
                    if(isMetformin) { show('guidance-metformin', "HOLD METFORMIN (Contraindicated in AKI)."); r.notes.push("Metformin: HOLD (AKI)."); }
                } else {
                    const gbcm = getVal('gbcm');
                    if (gbcm !== 'group2') {
                        setStyle('danger');
                        riskTitle.innerText = "HIGH RISK (NSF)";
                        recText.innerText = "CONTRAINDICATED. Use Group II only.";
                        show('guidance-alternatives', "Switch to Group II GBCM or use non-contrast MRI.");
                    } else {
                        setStyle('caution');
                        riskTitle.innerText = "CAUTION ADVISED";
                        recText.innerText = "PROCEED W/ CAUTION. High-risk population.";
                        show('guidance-main', "ACR: Group II safe, but this is a high-risk population. Defer if possible, use standard dose, obtain consent.");
                    }
                }
                r.risk = riskTitle.innerText; r.rec = recText.innerText; updateReport(r); return;
            }

            // C. Standard Patient (eGFR Logic)
            if (proc === 'ct') {
                const route = getVal('ct_route');
                const hasRiskFactors = document.getElementById('is-nephrotoxic').checked || document.getElementById('is-single-kidney').checked;
                
                let thresh = localPolicy.ct_iv;
                if (route === 'ia_other') thresh = localPolicy.ct_ia_other;
                if (route === 'ia_renal') thresh = localPlayer.ct_ia_renal; // Bug: Changed to localPolicy

                let needsPrep = false;
                let riskReason = "";
                if (egfr < thresh) {
                    needsPrep = true;
                    riskReason = `(eGFR < ${thresh})`;
                } else if (egfr < (thresh + 15) && hasRiskFactors) {
                    needsPrep = true;
                    riskReason = `(eGFR < ${thresh + 15} + Comorbidities)`;
                }

                if (needsPrep) {
                    setStyle('caution');
                    riskTitle.innerText = `MODERATE RISK ${riskReason}`;
                    recText.innerText = "PROCEED W/ CAUTION. Hydration & Consent.";
                    show('guidance-renal', `Prophylactic IV hydration (e.g., 0.9% NaCl) is recommended. Hold nephrotoxins if possible.`);
                } else {
                    setStyle('safe');
                    riskTitle.innerText = "LOW RISK";
                    recText.innerText = "PROCEED. No hydration required.";
                }

                if (isMetformin) {
                    const isIA = route.includes('ia_');
                    if (egfr < 30 || isIA) {
                        show('guidance-metformin', "HOLD 48 HOURS. Restart after stable renal function.");
                        r.notes.push("Metformin: HOLD 48h.");
                    } else {
                        show('guidance-metformin', "NO HOLD REQUIRED (eGFR â‰¥ 30 & IV).");
                    }
                }

            } else { // MRI
                const gbcm = getVal('gbcm');
                if (egfr < localPolicy.mri) {
                    if (gbcm !== 'group2') {
                        setStyle('danger');
                        riskTitle.innerText = "HIGH RISK (NSF)";
                        recText.innerText = "CONTRAINDICATED. Switch to Group II.";
                        show('guidance-alternatives', "Use Group II (Macrocyclic) GBCM or non-contrast MRI.");
                    } else {
                        setStyle('caution');
                        riskTitle.innerText = "LOW RISK (NSF)";
                        recText.innerText = "PROCEED W/ CAUTION. Standard dose.";
                        show('guidance-main', "ACR: Group II is safe, but eGFR is low. Use standard dose and obtain consent.");
                    }
                } else {
                    if (gbcm !== 'group2') {
                        setStyle('danger'); // Even with good eGFR, avoiding Group 1 is modern standard
                        riskTitle.innerText = "RISK WARNING (NSF)";
                        recText.innerText = "AVOID Group I/III. Switch to Group II.";
                        show('guidance-main', "Even with normal eGFR, Group I/III agents are associated with gadolinium retention and should be avoided per modern standards.");
                    } else {
                        setStyle('safe');
                        riskTitle.innerText = "LOW RISK (NSF)";
                        recText.innerText = "PROCEED.";
                    }
                }
            }

            r.risk = riskTitle.innerText;
            r.rec = recText.innerText;
            // Collect visible notes
            ['guidance-main','guidance-renal','guidance-metformin'].forEach(id => {
                const el = document.getElementById(id);
                if (el && !el.classList.contains('hidden')) {
                    const textChild = el.children[1];
                    if (textChild) r.notes.push(textChild.innerText);
                }
            });
            updateReport(r);
        }

        function updateReport(r) {
            const notes = r.notes.length ? `\nNotes: ${r.notes.join(' | ')}` : '';
            const txt = `**Plexura Safety Advisor**\nPt: ${r.pat}, eGFR: ${r.egfr}\nStatus: ${r.status || 'Standard'}\nRisk: ${r.risk}\nRec: ${r.rec}${notes}\n(Clinical judgment prevails.)`;
            document.getElementById('report-text').innerText = txt;
        }

        form.addEventListener('input', updateUI);
        
        // Clipboard Logic
        const copyBtn = document.getElementById('copy-button');
        const copyIcon = document.getElementById('copy-icon');
        if (typeof ClipboardJS !== 'undefined') {
            const cb = new ClipboardJS('#copy-button');
            cb.on('success', (e) => {
                const oldText = copyBtn.innerHTML;
                copyBtn.innerHTML = "âœ… Copied!";
                copyBtn.classList.replace('bg-blue-600', 'bg-green-600');
                copyBtn.classList.remove('hover:bg-blue-700');
                setTimeout(() => { 
                    copyBtn.innerHTML = oldText;
                    copyBtn.classList.replace('bg-green-600', 'bg-blue-600');
                    copyBtn.classList.add('hover:bg-blue-700');
                }, 2000);
                e.clearSelection();
            });
            cb.on('error', (e) => {
                alert('Copy failed. Please copy manually.');
            });
        } else {
            console.warn('Clipboard.js not loaded. Copy button disabled.');
            copyBtn.disabled = true;
            copyBtn.innerHTML = "Copy Unavailable";
            copyBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        // Init
        updateUI();
    });
    </script>
</body>
</html>
