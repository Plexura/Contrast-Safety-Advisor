<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plexura Universal Safety Advisor</title>
    <link href="tailwind.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="clipboard.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type="radio"]:checked + label,
        input[type="checkbox"]:checked + label { border-color: #2563eb; background-color: #eff6ff; }
        input[type="radio"][data-risk="true"]:checked + label { border-color: #f59e0b; background-color: #fffbeb; }
        input[type="radio"][data-danger="true"]:checked + label { border-color: #ef4444; background-color: #fef2f2; }
        input[type="radio"], input[type="checkbox"] { display: none; }
        .result-safe { background-color: #f0fdf4; border-color: #22c55e; }
        .result-caution { background-color: #fffbeb; border-color: #f59e0b; }
        .result-danger { background-color: #fef2f2; border-color: #ef4444; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        #policy-button { transition: background-color 0.15s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div id="settings-modal" class="modal fixed inset-0 z-40 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div id="settings-modal-content" class="modal-content w-full max-w-lg bg-white rounded-2xl shadow-xl p-6 transform scale-95">
             <div class="flex items-center justify-between mb-4"><h3 class="text-xl font-bold text-gray-900">Local Policy Settings</h3><button id="close-settings" class="text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button></div>
            <p class="text-sm text-gray-600 mb-6">Set eGFR thresholds for "Moderate Risk" warnings.</p>
            <div class="space-y-4">
                <div><label for="ct-iv-threshold" class="block text-sm font-medium text-gray-700">CT (IV) Caution eGFR</label><input type="number" id="ct-iv-threshold" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="30"><p class="text-xs text-gray-500 mt-1">Default (ACR): 30</p></div>
                <div><label for="ct-ia-other-threshold" class="block text-sm font-medium text-gray-700">CT (IA - Other) Caution eGFR</label><input type="number" id="ct-ia-other-threshold" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="40"><p class="text-xs text-gray-500 mt-1">Default (ACR): 40</p></div>
                <div><label for="ct-ia-renal-threshold" class="block text-sm font-medium text-gray-700">CT (IA - Renal) Caution eGFR</label><input type="number" id="ct-ia-renal-threshold" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="60"><p class="text-xs text-gray-500 mt-1">Default (ACR): 60</p></div>
                <div><label for="mri-threshold" class="block text-sm font-medium text-gray-700">MRI (GBCM) Caution eGFR</label><input type="number" id="mri-threshold" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="30"><p class="text-xs text-gray-500 mt-1">Default (ACR): 30</p></div>
            </div>
            <div class="mt-6 flex justify-between items-center"><button id="reset-settings" class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-all">Reset to Default</button><button id="save-settings" class="px-5 py-2 bg-blue-600 text-white rounded-lg shadow-sm font-medium hover:bg-blue-700 transition-all">Save and Close</button></div>
        </div>
    </div>

    <div id="nephrotoxic-modal" class="modal fixed inset-0 z-50 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div id="nephrotoxic-modal-content" class="modal-content w-full max-w-lg bg-white rounded-2xl shadow-xl p-6 transform scale-95">
            <div class="flex items-center justify-between mb-4"><h3 class="text-xl font-bold text-gray-900">Nephrotoxic Drug Check</h3><button id="close-nephrotoxic" class="text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button></div>
            <p class="text-sm text-gray-600 mb-6">Ask about common classes. Check if patient takes *any* or if unsure.</p>
            <ul class="space-y-4 text-sm">
                <li><strong class="font-semibold text-gray-800">1. NSAIDs:</strong><p class="text-gray-600">"Painkillers like Ibuprofen, Naproxen, Diclofenac?"</p></li>
                <li><strong class="font-semibold text-gray-800">2. IV Antibiotics (Inpatients):</strong><p class="text-gray-600">Gentamicin, Amikacin, Tobramycin, Vancomycin?</p></li>
                <li><strong class="font-semibold text-gray-800">3. Diuretics (Water Pills):</strong><p class="text-gray-600">"Furosemide (Lasix)?" (Risk via volume depletion).</p></li>
            </ul>
            <button id="close-nephrotoxic-2" class="mt-6 w-full px-5 py-2 bg-blue-600 text-white rounded-lg shadow-sm font-medium hover:bg-blue-700 transition-all">Close</button>
        </div>
    </div>

     <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="p-6 md:p-8 border-b border-gray-200 flex flex-col items-center">
            <img src="contrast.png" alt="Plexura Logo" class="w-40 h-40 rounded-full mb-6 shadow-lg object-cover" onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='flex';">
            <div id="logo-fallback" class="w-40 h-40 rounded-full mb-6 shadow-lg bg-blue-600 flex items-center justify-center" style="display: none;"><span class="text-5xl font-bold text-white">P</span></div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 text-center"><span class="text-blue-600">Plexura</span> Universal Safety Advisor</h1>
            <button id="policy-button" class="mt-2 text-sm md:text-base text-gray-600 text-center p-2 rounded-lg hover:bg-gray-100 cursor-pointer transition-all">Using Default ACR v2024 Guidelines <span class="text-blue-600 font-medium">(Click to edit)</span></button>
        </div>

        <div class="md:grid md:grid-cols-5">
            <form id="advisor-form" class="md:col-span-2 p-6 md:p-8 space-y-6 border-r border-gray-200">
                <fieldset class="space-y-3">
                    <legend class="text-lg font-semibold text-gray-900 mb-2">1. Patient Data</legend>
                    <div><label for="creatinine" class="block text-sm font-medium text-gray-700">Serum Creatinine</label><div class="mt-1 flex rounded-md shadow-sm"><input type="number" id="creatinine" min="0.1" max="30" step="0.01" class="flex-1 block w-full rounded-none rounded-l-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="1.2" required><span class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">mg/dL</span></div></div>
                    <div><label for="age" class="block text-sm font-medium text-gray-700">Age</label><input type="number" id="age" min="1" max="120" step="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="65" required></div>
                    <div><label class="block text-sm font-medium text-gray-700">Sex</label><div class="mt-1 grid grid-cols-2 gap-3"><input type="radio" name="sex" value="female" id="sex-female"><label for="sex-female" class="flex items-center justify-center w-full p-3 rounded-md border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="text-gray-700 font-medium">Female</span></label><input type="radio" name="sex" value="male" id="sex-male" checked><label for="sex-male" class="flex items-center justify-center w-full p-3 rounded-md border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="text-gray-700 font-medium">Male</span></label></div></div>
                </fieldset>
                <fieldset class="space-y-3">
                    <legend class="text-lg font-semibold text-gray-900 mb-2">2. Procedure</legend>
                    <input type="radio" name="procedure" value="ct" id="proc-ct" checked><label for="proc-ct" class="flex items-center justify-between w-full p-4 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="font-medium text-gray-800">CT w/ Iodinated Contrast</span></label>
                    <div id="ct-options" class="space-y-3 pt-2 pl-4 border-l-2 border-blue-200"> <label class="block text-sm font-medium text-gray-700">CT Route:</label><input type="radio" name="ct_route" value="iv" id="ct-iv" checked><label for="ct-iv" class="flex flex-col w-full p-3 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="font-medium text-gray-800">IV</span><span class="text-sm text-gray-600">Std CT, CTU</span></label><input type="radio" name="ct_route" value="ia_other" id="ct-ia-other"><label for="ct-ia-other" class="flex flex-col w-full p-3 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="font-medium text-gray-800">IA - Other</span><span class="text-sm text-gray-600">High vol (PCI, Cerebral)</span></label><input type="radio" name="ct_route" value="ia_renal" id="ct-ia-renal"><label for="ct-ia-renal" class="flex flex-col w-full p-3 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="font-medium text-gray-800">IA - Renal</span><span class="text-sm text-gray-600">Highest risk (Renal Angio)</span></label></div>
                    <input type="radio" name="procedure" value="mri" id="proc-mri"><label for="proc-mri" class="flex items-center justify-between w-full p-4 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="font-medium text-gray-800">MRI w/ Gadolinium Contrast</span></label>
                    <div id="mri-options" class="hidden space-y-3 pt-2 pl-4 border-l-2 border-blue-200"><label class="block text-sm font-medium text-gray-700">GBCM Type:</label><input type="radio" name="gbcm" value="group1" id="gbcm-g1" data-danger="true"><label for="gbcm-g1" class="flex flex-col w-full p-3 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="font-medium text-gray-800">Group I (Highest Risk NSF)</span><span class="text-sm text-gray-600">e.g., Magnevist</span></label><input type="radio" name="gbcm" value="group2" id="gbcm-g2" checked><label for="gbcm-g2" class="flex flex-col w-full p-3 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="font-medium text-gray-800">Group II (Lowest Risk NSF)</span><span class="text-sm text-gray-600">e.g., Gadavist</span></label><input type="radio" name="gbcm" value="group3" id="gbcm-g3" data-danger="true"><label for="gbcm-g3" class="flex flex-col w-full p-3 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="font-medium text-gray-800">Group III (Limited Data)</span><span class="text-sm text-gray-600">e.g., Eovist</span></label></div>
                </fieldset>
                <fieldset class="space-y-4 pt-4 border-t border-gray-200">
                    <legend class="text-lg font-semibold text-gray-900 mb-2">3. Clinical Safety Checklist<span class="block text-sm text-gray-500 font-normal">Defaults set for low-risk. Please verify.</span></legend>
                    <div><label class="block text-sm font-medium text-gray-700">Previous Reaction?</label><div class="mt-2 grid grid-cols-2 gap-3"><input type="radio" name="reaction" value="no" id="reaction-no" checked><label for="reaction-no" class="text-center w-full p-3 rounded-md border border-gray-300 cursor-pointer hover:bg-gray-50 text-gray-700 font-medium">No / Unknown</label><input type="radio" name="reaction" value="yes" id="reaction-yes" data-danger="true"><label for="reaction-yes" class="text-center w-full p-3 rounded-md border border-gray-300 cursor-pointer hover:bg-gray-50 text-gray-700 font-medium">Yes (Mod/Severe)</label></div></div>
                    <div><label class="block text-sm font-medium text-gray-700">ASA Fasting? <span class="font-normal">(6h solids/2h clears)</span></label><div class="mt-2 grid grid-cols-2 gap-3"><input type="radio" name="fasting" value="yes" id="fasting-yes" checked><label for="fasting-yes" class="text-center w-full p-3 rounded-md border border-gray-300 cursor-pointer hover:bg-gray-50 text-gray-700 font-medium">Yes (Compliant)</label><input type="radio" name="fasting" value="no" id="fasting-no" data-risk="true"><label for="fasting-no" class="text-center w-full p-3 rounded-md border border-gray-300 cursor-pointer hover:bg-gray-50 text-gray-700 font-medium">No (Not Compliant)</label></div></div>
                    <input type="checkbox" id="is-metformin" name="is-metformin"><label for="is-metformin" class="flex items-center justify-between w-full p-3 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="font-medium text-gray-800">Patient on Metformin</span></label>
                    <div><input type="checkbox" id="is-nephrotoxic" name="is-nephrotoxic"><label for="is-nephrotoxic" class="flex items-center justify-between w-full p-3 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="font-medium text-gray-800">Patient on High-Risk Nephrotoxins</span></label><span id="nephrotoxic-help" class="text-xs text-blue-600 hover:text-blue-800 cursor-pointer font-medium pl-1">Common Examples?</span></div>
                    <input type="checkbox" id="is-single-kidney" name="is-single-kidney"><label for="is-single-kidney" class="flex items-center justify-between w-full p-3 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="font-medium text-gray-800">Single Kidney</span></label>
                    <div id="pregnancy-option-container" class="hidden"><input type="checkbox" id="is-pregnant" name="is-pregnant"><label for="is-pregnant" class="flex items-center justify-between w-full p-3 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="font-medium text-red-700">Patient is Pregnant</span><svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="display: none;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg></label></div>
                </fieldset>
                <fieldset class="space-y-3 pt-4 border-t border-gray-200">
                    <legend class="text-lg font-semibold text-gray-900 mb-2">4. Renal Status</legend>
                    <input type="radio" name="status" value="standard" id="status-standard" checked><label for="status-standard" class="flex flex-col w-full p-4 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="font-medium text-gray-800">Standard Patient</span><span class="text-sm text-gray-600">Stable/unknown baseline.</span></label>
                    <input type="radio" name="status" value="aki" id="status-aki" data-danger="true"><label for="status-aki" class="flex flex-col w-full p-4 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="font-medium text-gray-800">Acute Kidney Injury (AKI)</span><span class="text-sm text-gray-600">Unstable renal function.</span></label>
                    <input type="radio" name="status" value="dialysis" id="status-dialysis" data-risk="true"><label for="status-dialysis" class="flex flex-col w-full p-4 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="font-medium text-gray-800">Patient on Dialysis (ESRD)</span><span class="text-sm text-gray-600">e.g., HD or PD.</span></label>
                    <div id="dialysis-options" class="hidden space-y-3 pt-2 pl-4 border-l-2 border-blue-200"><label class="block text-sm font-medium text-gray-700">Dialysis Workflow (MRI only):</label><input type="checkbox" id="dialysis-high-dose" name="dialysis-high-dose"><label for="dialysis-high-dose" class="flex items-center justify-between w-full p-3 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="font-medium text-gray-800">High Dose MRI?</span></label><input type="checkbox" id="dialysis-delayed" name="dialysis-delayed"><label for="dialysis-delayed" class="flex items-center justify-between w-full p-3 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-50 transition-all"><span class="font-medium text-gray-800">Next Dialysis > 24h Post?</span></label></div>
                </fieldset>
            </form>

            <div class="md:col-span-3 bg-gray-50 p-6 md:p-8">
                <div class="sticky top-8 space-y-6">
                    <div class="p-5 rounded-xl bg-white border border-gray-200 shadow-sm"><span class="text-sm font-medium text-gray-500">Calculated eGFR (2021 CKD-EPI)</span><p id="egfr-result" class="text-4xl font-bold text-blue-600">--</p><p class="text-sm text-gray-500">mL/min/1.73m²</p></div>
                    <div id="result-card" class="p-5 rounded-xl border-2 result-caution">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">Risk Profile</h3><p id="risk-profile" class="text-xl font-bold text-yellow-700">AWAITING INPUT</p>
                        <hr class="my-4 border-gray-300">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Final Recommendation</h3><p id="recommendation" class="text-gray-800 font-medium">Please enter patient data and verify safety checklist.</p>
                        <div id="guidance-main" class="mt-4 hidden"><h4 class="font-semibold text-gray-800">Primary Advisory:</h4><p id="guidance-main-text" class="text-sm text-gray-700"></p></div>
                        <div id="guidance-renal" class="mt-4 hidden"><h4 class="font-semibold text-gray-800">Renal Advisory:</h4><p id="renal-text" class="text-sm text-gray-700"></p></div>
                        <div id="guidance-metformin" class="mt-4 hidden"><h4 class="font-semibold text-gray-800">Metformin Advisory (ACR):</h4><p id="metformin-text" class="text-sm text-gray-700"></p></div>
                        <div id="guidance-alternatives" class="mt-4 hidden"><h4 class="font-semibold text-gray-800">Alternative Pathways:</h4><p id="alternatives-text" class="text-sm text-gray-700"></p>
                        </div>
                    </div>
                    <button id="copy-button" data-clipboard-target="#report-text" class="w-full flex items-center justify-center p-4 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-all shadow-sm">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3.5A1.5 1.5 0 018.5 2h3.879a1.5 1.5 0 011.06.44l3.122 3.12A1.5 1.5 0 0117 6.622V17.5a1.5 1.5 0 01-1.5 1.5h-7A1.5 1.5 0 017 17.5v-14z" /><path d="M5 4.5A1.5 1.5 0 016.5 3H7v14.5A1.5 1.5 0 015.5 19h-2A1.5 1.5 0 012 17.5v-11A1.5 1.5 0 013.5 5H5v-.5z" /></svg>
                        Copy for Report
                    </button>
                    <span id="copy-success" class="hidden"></span>
                    <div id="report-text" style="position: absolute; left: -9999px; top: 0; opacity: 0;"></div>
                </div>
            </div>
        </div>
        <footer class="p-6 text-center text-sm text-gray-500">
            © Plexura 2025 · The Living Mind of Diagnostic Intelligence · For educational use only.
            <span class="mx-1">|</span>
            <a href="contrast-reference.pdf" target="_blank" class="text-blue-600 hover:underline">Reference Document</a>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Default Policy ---
            const defaultPolicy = { ct_iv: 30, ct_ia_other: 40, ct_ia_renal: 60, mri: 30 };
            let localPolicy = JSON.parse(localStorage.getItem('plexuraPolicy')) || { ...defaultPolicy };

            // --- Modal Functions ---
            const openModal = (modal, content) => { modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); content.classList.remove('scale-95'); }, 10); };
            const closeModal = (modal, content) => { modal.classList.add('opacity-0'); content.classList.add('scale-95'); setTimeout(() => modal.classList.add('hidden'), 250); };

            // --- Settings Modal Elements & Logic ---
            const policyButton = document.getElementById('policy-button');
            const settingsModal = document.getElementById('settings-modal');
            const settingsModalContent = document.getElementById('settings-modal-content');
            const closeSettingsButton = document.getElementById('close-settings');
            const saveSettingsButton = document.getElementById('save-settings');
            const resetSettingsButton = document.getElementById('reset-settings');
            const policyDisplayEl = document.getElementById('policy-button');
            const ctIvThresholdEl = document.getElementById('ct-iv-threshold');
            const ctIaOtherThresholdEl = document.getElementById('ct-ia-other-threshold');
            const ctIaRenalThresholdEl = document.getElementById('ct-ia-renal-threshold');
            const mriThresholdEl = document.getElementById('mri-threshold');

            function updatePolicyDisplay() {
                const isDefault = Object.keys(defaultPolicy).every(key => localPolicy[key] === defaultPolicy[key]);
                policyDisplayEl.innerHTML = `Using ${isDefault ? 'Default ACR v2024' : 'Local'} Guidelines (CT-IV < ${localPolicy.ct_iv}, MRI < ${localPolicy.mri}) <span class="text-blue-600 font-medium">(Click to edit)</span>`;
            }
            policyButton.addEventListener('click', () => { ctIvThresholdEl.value = localPolicy.ct_iv; ctIaOtherThresholdEl.value = localPolicy.ct_ia_other; ctIaRenalThresholdEl.value = localPolicy.ct_ia_renal; mriThresholdEl.value = localPolicy.mri; openModal(settingsModal, settingsModalContent); });
            closeSettingsButton.addEventListener('click', () => closeModal(settingsModal, settingsModalContent));
            saveSettingsButton.addEventListener('click', () => { localPolicy.ct_iv = parseInt(ctIvThresholdEl.value) || defaultPolicy.ct_iv; localPolicy.ct_ia_other = parseInt(ctIaOtherThresholdEl.value) || defaultPolicy.ct_ia_other; localPolicy.ct_ia_renal = parseInt(ctIaRenalThresholdEl.value) || defaultPolicy.ct_ia_renal; localPolicy.mri = parseInt(mriThresholdEl.value) || defaultPolicy.mri; localStorage.setItem('plexuraPolicy', JSON.stringify(localPolicy)); updatePolicyDisplay(); updateRecommendations(); closeModal(settingsModal, settingsModalContent); });
            resetSettingsButton.addEventListener('click', () => { localPolicy = { ...defaultPolicy }; localStorage.removeItem('plexuraPolicy'); ctIvThresholdEl.value = defaultPolicy.ct_iv; ctIaOtherThresholdEl.value = defaultPolicy.ct_ia_other; ctIaRenalThresholdEl.value = defaultPolicy.ct_ia_renal; mriThresholdEl.value = defaultPolicy.mri; updatePolicyDisplay(); updateRecommendations(); closeModal(settingsModal, settingsModalContent); });

            // --- Nephrotoxic Modal Logic ---
            const nephrotoxicHelpButton = document.getElementById('nephrotoxic-help');
            const nephrotoxicModal = document.getElementById('nephrotoxic-modal');
            const nephrotoxicModalContent = document.getElementById('nephrotoxic-modal-content');
            const closeNephrotoxicButton = document.getElementById('close-nephrotoxic');
            const closeNephrotoxicButton2 = document.getElementById('close-nephrotoxic-2');
            nephrotoxicHelpButton.addEventListener('click', (e) => { e.preventDefault(); openModal(nephrotoxicModal, nephrotoxicModalContent); });
            closeNephrotoxicButton.addEventListener('click', () => closeModal(nephrotoxicModal, nephrotoxicModalContent));
            closeNephrotoxicButton2.addEventListener('click', () => closeModal(nephrotoxicModal, nephrotoxicModalContent));

             // --- Gemini Modal Logic (Commented Out for Offline) ---
            /*
            const geminiModal = document.getElementById('gemini-modal');
            const geminiModalContent = document.getElementById('gemini-modal-content');
            const closeGeminiButton = document.getElementById('close-gemini');
            const closeGeminiButton2 = document.getElementById('close-gemini-2');
            closeGeminiButton.addEventListener('click', () => closeModal(geminiModal, geminiModalContent));
            closeGeminiButton2.addEventListener('click', () => closeModal(geminiModal, geminiModalContent));
            */

            // --- Clipboard.js Init ---
            const copyButton = document.getElementById('copy-button');
            // Check if ClipboardJS is defined (loaded locally)
            if (typeof ClipboardJS !== 'undefined') {
                const clipboard = new ClipboardJS('#copy-button');
                const originalCopyText = copyButton.innerHTML;
                clipboard.on('success', (e) => { copyButton.innerHTML = `<svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg>Copied!`; copyButton.classList.replace('bg-blue-600', 'bg-green-600'); copyButton.classList.remove('hover:bg-blue-700'); setTimeout(() => { copyButton.innerHTML = originalCopyText; copyButton.classList.replace('bg-green-600', 'bg-blue-600'); copyButton.classList.add('hover:bg-blue-700'); }, 2000); e.clearSelection(); });
                clipboard.on('error', (e) => { console.error('Clipboard error:', e); alert('Failed to copy. Please copy manually.'); });
            } else {
                console.warn('Clipboard.js not loaded. Copy button will not function.');
                copyButton.disabled = true;
                 copyButton.textContent = 'Copy Unavailable (Offline)';
                 copyButton.classList.add('opacity-50', 'cursor-not-allowed');
            }


            // --- Form DOM Elements ---
            const form = document.getElementById('advisor-form');
            const creatinineEl = document.getElementById('creatinine');
            const ageEl = document.getElementById('age');
            const mriOptions = document.getElementById('mri-options');
            const ctOptions = document.getElementById('ct-options');
            const dialysisOptions = document.getElementById('dialysis-options');
            const sexFemaleEl = document.getElementById('sex-female');
            const sexMaleEl = document.getElementById('sex-male'); // Added
            const pregnancyOptionContainer = document.getElementById('pregnancy-option-container');
            const isPregnantEl = document.getElementById('is-pregnant');
            const egfrResultEl = document.getElementById('egfr-result');
            const resultCard = document.getElementById('result-card');
            const riskProfileEl = document.getElementById('risk-profile');
            const recommendationEl = document.getElementById('recommendation');
            const guidanceMain = document.getElementById('guidance-main');
            const guidanceRenal = document.getElementById('guidance-renal');
            const guidanceMetformin = document.getElementById('guidance-metformin');
            const guidanceAlternatives = document.getElementById('guidance-alternatives');
            const reportTextEl = document.getElementById('report-text');
            // const explainButton = document.getElementById('explain-button'); // Commented out
            // const alternativesButton = document.getElementById('alternatives-button'); // Commented out

            // --- Event Listeners ---
            form.addEventListener('input', updateRecommendations);
            // explainButton.addEventListener('click', handleGeminiExplain); // Commented out
            // alternativesButton.addEventListener('click', handleGeminiAlternatives); // Commented out

            // --- UI Show/Hide Logic ---
            function toggleConditionalUI() {
                const procedure = getFormValue('procedure');
                const status = getFormValue('status');
                mriOptions.classList.toggle('hidden', procedure !== 'mri');
                ctOptions.classList.toggle('hidden', procedure === 'mri');
                dialysisOptions.classList.toggle('hidden', !(status === 'dialysis' && procedure === 'mri'));
                pregnancyOptionContainer.classList.toggle('hidden', !sexFemaleEl.checked);
                if (sexMaleEl.checked && isPregnantEl.checked) { isPregnantEl.checked = false; } // Corrected logic check
                const warningIcon = isPregnantEl.labels[0].querySelector('svg');
                warningIcon.style.display = isPregnantEl.checked ? 'block' : 'none';
                // explainButton.disabled = !creatinineEl.value || !ageEl.value; // Commented out
            }

            // --- Helper Functions ---
            const getFormValue = (name) => document.querySelector(`input[name="${name}"]:checked`).value;
            const clearGuidance = () => { [guidanceMain, guidanceRenal, guidanceMetformin, guidanceAlternatives].forEach(el => el.classList.add('hidden')); };
            const showGuidance = (el, text) => { el.classList.remove('hidden'); el.children[1].innerHTML = text; };
            const setRisk = (cardClass, profileText, profileClass) => { resultCard.className = `p-5 rounded-xl border-2 ${cardClass}`; riskProfileEl.textContent = profileText; riskProfileEl.className = `text-xl font-bold ${profileClass}`; };

            // --- Calculation ---
            function calculateCKDEPI(creat_mgdl, age, isFemale) {
                 if (!creat_mgdl || !age || creat_mgdl <= 0 || age <= 0) return null;
                const k = isFemale ? 0.7 : 0.9, alpha = isFemale ? -0.241 : -0.302;
                const min_cr_k = Math.min(creat_mgdl / k, 1), max_cr_k = Math.max(creat_mgdl / k, 1);
                let egfr = 142 * Math.pow(min_cr_k, alpha) * Math.pow(max_cr_k, -1.200) * Math.pow(0.9938, age);
                if (isFemale) { egfr *= 1.012; }
                return Math.round(egfr);
            }

             // --- Gemini Functions (Commented Out for Offline) ---
             /*
             async function callGeminiApi(prompt, systemInstruction = null) {
                 // ... API call logic ...
             }
             function handleGeminiExplain() {
                 // ... Explain logic ...
             }
             function handleGeminiAlternatives() {
                // ... Alternatives logic ...
             }
             function getCurrentReportAndRec() {
                // ... Report parsing logic ...
             }
             function generateExplanationFocus(riskProfile, recommendation) {
                // ... Prompt tailoring logic ...
             }
            */

            // --- Main Logic ---
            function updateRecommendations() {
                toggleConditionalUI();
                const creat = parseFloat(creatinineEl.value), age = parseInt(ageEl.value);
                const isFemale = getFormValue('sex') === 'female', sexText = isFemale ? 'Female' : 'Male';
                const egfr = calculateCKDEPI(creat, age, isFemale);
                const reaction = getFormValue('reaction'), fasting = getFormValue('fasting');
                const isPregnant = isPregnantEl.checked;
                const isMetformin = document.getElementById('is-metformin').checked;
                const isNephrotoxic = document.getElementById('is-nephrotoxic').checked;
                const isSingleKidney = document.getElementById('is-single-kidney').checked;
                const status = getFormValue('status'), procedure = getFormValue('procedure');
                const ct_route = getFormValue('ct_route'), gbcm = getFormValue('gbcm');
                const isDialysisHighDose = document.getElementById('dialysis-high-dose').checked;
                const isDialysisDelayed = document.getElementById('dialysis-delayed').checked;

                clearGuidance();
                // alternativesButton.classList.add('hidden'); // Commented out

                if (!creat || !age || egfr === null) { // Check egfr calculation result too
                    egfrResultEl.textContent = egfr === null && creat && age ? "Invalid Input" : "--";
                    setRisk('result-caution', 'AWAITING INPUT', 'text-yellow-700');
                    recommendationEl.textContent = 'Please enter valid patient data and verify safety checklist.';
                    reportTextEl.innerText = "Awaiting valid input.";
                    // explainButton.disabled = true; // Commented out
                    return;
                }
                egfrResultEl.textContent = egfr;
                // explainButton.disabled = false; // Commented out

                let report = { patient: `${age} y/o ${sexText}, Cr ${creat} mg/dL`, egfr: `eGFR: ${egfr} mL/min/1.73m²`, status: '', procedure: '', risk: '', recommendation: '', notes: [] };
                let showAlternatives = false;

                // --- PILLAR 1: IMMEDIATE FATAL RISK ---
                 if (isPregnant) {
                    report.status = "PREGNANT"; report.procedure = procedure === 'ct' ? "CT" : "MRI"; setRisk('result-danger', 'HIGH RISK (FETAL EXPOSURE)', 'text-red-700');
                    if (procedure === 'ct') { recommendationEl.textContent = 'DEFER SCAN (Radiation).'; showGuidance(guidanceMain, 'ICM low risk, but scan deferred.'); showGuidance(guidanceAlternatives, 'US or non-contrast MRI.'); report.risk = "HIGH RISK (Fetal Radiation)"; report.recommendation = "DEFER SCAN. Discuss w/ OBGYN."; }
                    else { recommendationEl.textContent = 'CONTRAINDICATED (GBCM).'; showGuidance(guidanceMain, 'GBCMs cross placenta, trapped.'); showGuidance(guidanceAlternatives, 'Non-contrast MRI or US.'); report.risk = "HIGH RISK (Fetal GBCM Exposure)"; report.recommendation = "CONTRAINDICATED. Defer post-partum."; }
                    showAlternatives = true; finalizeReport(report); return;
                }
                if (reaction === 'yes') {
                    report.status = "History of Mod/Severe Reaction"; report.procedure = procedure === 'ct' ? "CT" : "MRI"; setRisk('result-danger', 'HIGH RISK (ANAPHYLAXIS)', 'text-red-700');
                    recommendationEl.textContent = 'STOP. HIGH RISK for severe reaction.'; showGuidance(guidanceMain, 'Consult radiologist re: safety of different contrast class.'); showGuidance(guidanceAlternatives, 'Consult radiologist for pre-med protocol OR switch modality.'); report.risk = "HIGH RISK (Anaphylaxis)"; report.recommendation = "STOP. Consult radiologist.";
                    showAlternatives = true; finalizeReport(report); return;
                }
                if (fasting === 'no') {
                    report.status = "Not ASA Fasting Compliant"; report.procedure = "Elective Procedure"; setRisk('result-caution', 'MODERATE RISK (ASPIRATION)', 'text-yellow-700');
                    recommendationEl.textContent = 'DEFER ELECTIVE SCAN (Aspiration Risk).'; showGuidance(guidanceMain, 'Reschedule when NPO protocol (6h solids/2h clears) is met.'); showGuidance(guidanceAlternatives, 'If emergent, proceed with caution (suction ready).'); report.risk = "MODERATE RISK (Aspiration)"; report.recommendation = "DEFER ELECTIVE SCAN. Reschedule when NPO.";
                    finalizeReport(report); return;
                }

                // --- PILLAR 2: RENAL STATUS ---
                 if (status === 'dialysis') {
                    report.status = "On Dialysis (ESRD)"; report.egfr = "eGFR: N/A"; report.notes.push("Renal Policy: N/A.");
                    if (procedure === 'ct') { setRisk('result-safe', 'LOW RISK (RENAL)', 'text-green-700'); recommendationEl.textContent = 'PROCEED (ICM safe). No urgent dialysis needed.'; report.procedure = "CT w/ ICM"; report.risk = "LOW RISK (No PC-AKI)"; report.recommendation = "PROCEED. Normal dialysis schedule."; if (isMetformin) { showGuidance(guidanceMetformin, 'No hold needed.'); report.notes.push('Metformin: No hold required.'); }}
                    else { report.procedure = `MRI w/ ${gbcm.toUpperCase()} GBCM`;
                        if (gbcm === 'group1' || gbcm === 'group3') { setRisk('result-danger', 'HIGH RISK (NSF)', 'text-red-700'); recommendationEl.textContent = 'CONTRAINDICATED (Group I/III).'; showGuidance(guidanceAlternatives, 'Switch to Group II or alt modality.'); report.risk = "HIGH RISK (NSF)"; report.recommendation = "CONTRAINDICATED. Switch GBCM/modality."; showAlternatives = true; }
                        else { if (isDialysisHighDose || isDialysisDelayed) { setRisk('result-caution', 'MODERATE RISK (THEORETICAL NSF)', 'text-yellow-700'); recommendationEl.textContent = 'PROCEED W/ CAUTION (High Dose / >24h Dwell).'; showGuidance(guidanceMain, 'ACR: Grp II low risk. **Recommend dialysis < 24h.** Consent.'); report.risk = "MODERATE RISK (Theoretical NSF)"; report.recommendation = "PROCEED W/ CAUTION. Recommend dialysis < 24h. Consent."; }
                            else { setRisk('result-safe', 'LOW RISK (NSF)', 'text-green-700'); recommendationEl.textContent = 'PROCEED (Group II safe).'; report.risk = "LOW RISK (NSF)"; report.recommendation = "PROCEED. Normal dialysis schedule."; }
                        }
                    }
                    finalizeReport(report); return;
                 }
                 if (status === 'aki') {
                    report.status = "AKI"; report.egfr = "eGFR: N/A (Invalid)"; report.notes.push("Renal Policy: N/A.");
                    if (procedure === 'ct') { setRisk('result-danger', 'HIGH RISK for PC-AKI', 'text-red-700'); recommendationEl.textContent = 'DEFER SCAN if possible.'; showGuidance(guidanceMain, 'If unavoidable: low dose, hydrate, hold nephrotoxins, consent.'); showGuidance(guidanceAlternatives, 'Non-contrast CT/MRI, US.'); report.procedure = "CT w/ ICM"; report.risk = "HIGH RISK (PC-AKI)"; report.recommendation = "DEFER. If unavoidable, use precautions."; if (isMetformin) { showGuidance(guidanceMetformin, 'Metformin CONTRAINDICATED. Ensure held.'); report.notes.push('Metformin: HOLD (Contraindicated).'); } showAlternatives = true; }
                     else { report.procedure = `MRI w/ ${gbcm.toUpperCase()} GBCM`;
                        if (gbcm === 'group1' || gbcm === 'group3') { setRisk('result-danger', 'HIGH RISK (NSF)', 'text-red-700'); recommendationEl.textContent = 'CONTRAINDICATED (Group I/III).'; showGuidance(guidanceAlternatives, 'Switch to Group II or alt modality.'); report.risk = "HIGH RISK (NSF)"; report.recommendation = "CONTRAINDICATED. Switch GBCM/modality."; showAlternatives = true; }
                        else { setRisk('result-caution', 'CAUTION ADVISED', 'text-yellow-700'); recommendationEl.textContent = 'PROCEED W/ CAUTION (Group II in AKI).'; showGuidance(guidanceMain, 'ACR: No proven NSF w/ Grp II, but high-risk. Defer if possible. Lowest dose, consent.'); report.risk = "CAUTION (High-risk pop.)"; report.recommendation = "PROCEED W/ CAUTION. Use Group II lowest dose. Defer if possible."; }
                     }
                    finalizeReport(report); return;
                 }

                // --- 2C. Standard Patients ---
                report.status = "Standard Patient"; report.notes.push(`Renal Policy (Local): CT-IV < ${localPolicy.ct_iv}, MRI < ${localPolicy.mri}`);
                hydration_consent_required = false; riskReason = "";
                const hasComorbidities = isNephrotoxic || isSingleKidney;

                if (procedure === 'ct') {
                    report.procedure = `CT w/ ICM (${ct_route.toUpperCase()})`;
                    let threshold = localPolicy.ct_iv;
                    if (ct_route === 'ia_renal') threshold = localPolicy.ct_ia_renal;
                    else if (ct_route === 'ia_other') threshold = localPolicy.ct_ia_other;

                    if (egfr < threshold) { hydration_consent_required = true; riskReason = `(eGFR < ${threshold} for ${ct_route.toUpperCase()})`; }
                    else if (egfr < (threshold + 15) && hasComorbidities) { hydration_consent_required = true; riskReason = `(eGFR < ${threshold + 15} + Comorbidities)`; }

                    if (hydration_consent_required) { setRisk('result-caution', 'MODERATE RISK for PC-AKI', 'text-yellow-700'); recommendationEl.textContent = 'PROCEED W/ CAUTION. Consent required.'; showGuidance(guidanceRenal, 'Recommend IV hydration & holding nephrotoxins.'); showGuidance(guidanceAlternatives, 'Non-contrast CT/MRI, US.'); report.risk = `MODERATE RISK ${riskReason}`; report.recommendation = "MODERATE RISK. Recommend IV hydration, consent, hold nephrotoxins."; showAlternatives = true; }
                    else { setRisk('result-safe', 'LOW RISK for PC-AKI', 'text-green-700'); recommendationEl.textContent = 'PROCEED. Low risk. No hydration needed.'; report.risk = "LOW RISK"; report.recommendation = "PROCEED. No hydration needed."; }

                    if (isMetformin) {
                        const isIA = ct_route.includes('ia_');
                        if (egfr < 30 || isIA) { const txt = 'Hold Metformin @ procedure + 48h. Recheck renal fxn before restart.'; showGuidance(guidanceMetformin, txt); report.notes.push(`Metformin: HOLD. ${txt}`); }
                        else { const txt = 'No need to hold Metformin (eGFR ≥ 30 & IV).'; showGuidance(guidanceMetformin, txt); report.notes.push(`Metformin: No hold required.`); }
                    }

                } else { // MRI
                    report.procedure = `MRI w/ ${gbcm.toUpperCase()} GBCM`;
                    if (egfr >= localPolicy.mri) {
                         if (gbcm === 'group1' || gbcm === 'group3') { setRisk('result-danger', 'RISK of NSF', 'text-red-700'); recommendationEl.textContent = 'AVOID (Group I/III).'; showGuidance(guidanceAlternatives, 'Switch to Group II.'); report.risk = "RISK of NSF"; report.recommendation = "AVOID. Switch to Group II."; showAlternatives = true; }
                        else { setRisk('result-safe', 'LOW RISK (NSF)', 'text-green-700'); recommendationEl.textContent = 'PROCEED (Group II safe).'; report.risk = "LOW RISK (NSF)"; report.recommendation = "PROCEED."; }
                    } else { // eGFR < localPolicy.mri
                        if (gbcm === 'group1' || gbcm === 'group3') { setRisk('result-danger', 'HIGH RISK (NSF)', 'text-red-700'); recommendationEl.textContent = 'CONTRAINDICATED (Group I/III).'; showGuidance(guidanceAlternatives, 'Switch to Group II or alt modality.'); report.risk = "HIGH RISK (NSF)"; report.recommendation = "CONTRAINDICATED. Switch GBCM/modality."; showAlternatives = true; }
                        else { setRisk('result-caution', 'LOW RISK (NSF)', 'text-yellow-700'); recommendationEl.textContent = 'PROCEED W/ CAUTION (Group II).'; showGuidance(guidanceMain, 'ACR: Grp II safe, but high-risk pop. Use standard dose, consent.'); report.risk = "LOW RISK (NSF)"; report.recommendation = "PROCEED W/ CAUTION. Use Group II std dose. Consent."; }
                    }
                    if (isMetformin) { report.notes.push('Metformin: No hold required for GBCM.'); }
                }
                finalizeReport(report);
                // alternativesButton.classList.toggle('hidden', !showAlternatives); // Commented out
            } // End updateRecommendations

            function finalizeReport(report) {
                const notesText = report.notes.length > 0 ? report.notes.join('\n') : '';
                const text = `**Plexura Universal Safety Advisor**\nPatient: ${report.patient}\n${report.egfr}\nStatus: ${report.status}\nProcedure: ${report.procedure}\n---\nRisk Profile: ${report.risk}\nRecommendation: ${report.recommendation}\n---\n${notesText ? 'Notes:\n' + notesText + '\n' : ''}(Tool advises based on selected inputs. Clinical judgment prevails.)`.trim();
                reportTextEl.innerText = text;
            }

            // --- Initial Call ---
            updatePolicyDisplay();
            updateRecommendations(); // Run once on load
        });
    </script>
</body>
</html>
```eof

